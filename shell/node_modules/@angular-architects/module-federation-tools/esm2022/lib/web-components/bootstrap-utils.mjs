import { enableProdMode, NgZone, PlatformRef, } from '@angular/core';
import { platformBrowser } from '@angular/platform-browser';
import { VERSION } from '@angular/core';
import { getGlobalStateSlice, setGlobalStateSlice, } from '../utils/global-state';
import { Router } from '@angular/router';
import { connectRouter } from './router-utils';
let ngZoneSharing = true;
let platformSharing = true;
let legacyMode = true;
export function getMajor(version) {
    const pre = version.match(/\d+/)[0];
    const post = version.match(/-.*/);
    if (!pre) {
        throw new Error('Cound not identify major version: ' + version);
    }
    if (post) {
        return pre + post[0];
    }
    return pre;
}
function getLegacyPlatformCache() {
    const platformCache = window;
    platformCache.platform = platformCache.platform || {};
    return platformCache;
}
function getLegacyPlatform(key) {
    const platform = getLegacyPlatformCache().platform[key];
    /**
     * If dependencies are not shared, platform with same version is different
     * and shared platform will not be returned.
     */
    return platform instanceof PlatformRef ? platform : null;
}
function setLegacyPlatform(key, platform) {
    getLegacyPlatformCache().platform[key] = platform;
}
function getLegacyNgZone() {
    return window['ngZone'];
}
function setLegacyNgZone(zone) {
    window['ngZone'] = zone;
}
/**
 * LEGACY IMPLEMENTATIONS END
 */
function getPlatformCache() {
    return (getGlobalStateSlice((state) => state.platformCache) ||
        setGlobalStateSlice({
            platformCache: new Map(),
        }).platformCache);
}
function setPlatform(version, platform) {
    if (platformSharing) {
        legacyMode && setLegacyPlatform(version.full, platform);
        getPlatformCache().set(version, platform);
    }
}
function getPlatform(options) {
    if (!platformSharing) {
        return options.platformFactory();
    }
    const versionResult = options.version();
    const version = versionResult === VERSION.full ? VERSION : versionResult;
    const versionKey = typeof version === 'string' ? version : version.full;
    let platform = getPlatformCache().get(version) ||
        (legacyMode && getLegacyPlatform(versionKey));
    if (!platform) {
        platform = options.platformFactory();
        setPlatform(VERSION, platform);
        options.production && enableProdMode();
    }
    return platform;
}
function getNgZone() {
    return (getGlobalStateSlice((state) => state.ngZone) ||
        getLegacyNgZone());
}
export function shareNgZone(zone) {
    if (ngZoneSharing) {
        legacyMode && setLegacyNgZone(zone);
        setGlobalStateSlice({ ngZone: zone });
    }
}
export function bootstrap(module, options) {
    ngZoneSharing = options.ngZoneSharing !== false;
    platformSharing = options.platformSharing !== false;
    legacyMode = options.activeLegacyMode !== false;
    options.platformFactory =
        options.platformFactory || (() => platformBrowser());
    options.version = options.version || (() => VERSION);
    if (ngZoneSharing && !options.compilerOptions?.ngZone) {
        options.compilerOptions = options.compilerOptions || {};
        options.compilerOptions.ngZone = getNgZone();
    }
    return getPlatform(options)
        .bootstrapModule(module, options.compilerOptions)
        .then((ref) => {
        if (options.appType === 'shell') {
            shareShellZone(ref.injector);
        }
        else if (options.appType === 'microfrontend') {
            connectMicroFrontendRouter(ref.injector);
        }
        return ref;
    });
}
function shareShellZone(injector) {
    const ngZone = injector.get(NgZone, null);
    if (!ngZone) {
        console.warn('No NgZone to share found');
        return;
    }
    shareNgZone(ngZone);
}
function connectMicroFrontendRouter(injector) {
    const router = injector.get(Router);
    const useHash = location.href.includes('#');
    if (!router) {
        console.warn('No router to connect found');
        return;
    }
    connectRouter(router, useHash);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYm9vdHN0cmFwLXV0aWxzLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vbGlicy9tZi10b29scy9zcmMvbGliL3dlYi1jb21wb25lbnRzL2Jvb3RzdHJhcC11dGlscy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBRUwsY0FBYyxFQUdkLE1BQU0sRUFDTixXQUFXLEdBR1osTUFBTSxlQUFlLENBQUM7QUFDdkIsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLDJCQUEyQixDQUFDO0FBQzVELE9BQU8sRUFBRSxPQUFPLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDeEMsT0FBTyxFQUNMLG1CQUFtQixFQUNuQixtQkFBbUIsR0FDcEIsTUFBTSx1QkFBdUIsQ0FBQztBQUMvQixPQUFPLEVBQUUsTUFBTSxFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFDekMsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBc0MvQyxJQUFJLGFBQWEsR0FBRyxJQUFJLENBQUM7QUFDekIsSUFBSSxlQUFlLEdBQUcsSUFBSSxDQUFDO0FBQzNCLElBQUksVUFBVSxHQUFHLElBQUksQ0FBQztBQUV0QixNQUFNLFVBQVUsUUFBUSxDQUFDLE9BQWU7SUFDdEMsTUFBTSxHQUFHLEdBQUcsT0FBTyxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUNwQyxNQUFNLElBQUksR0FBRyxPQUFPLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDO0lBRWxDLElBQUksQ0FBQyxHQUFHLEVBQUU7UUFDUixNQUFNLElBQUksS0FBSyxDQUFDLG9DQUFvQyxHQUFHLE9BQU8sQ0FBQyxDQUFDO0tBQ2pFO0lBRUQsSUFBSSxJQUFJLEVBQUU7UUFDUixPQUFPLEdBQUcsR0FBRyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7S0FDdEI7SUFFRCxPQUFPLEdBQUcsQ0FBQztBQUNiLENBQUM7QUFlRCxT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QUFDLENBQUM7QUFDUCxDQUFDO0FBRUQsU0FBUyxjQUFjLENBQUMsUUFBa0I7SUFDeEMsTUFBTSxNQUFNLEdBQUcsUUFBUSxDQUFDLEdBQUcsQ0FBQyxNQUFNLEVBQUUsSUFBSSxDQUFDLENBQUM7SUFDMUMsSUFBSSxDQUFDLE1BQU0sRUFBRTtRQUNYLE9BQU8sQ0FBQyxJQUFJLENBQUMsMEJBQTBCLENBQUMsQ0FBQztRQUN6QyxPQUFPO0tBQ1I7SUFDRCxXQUFXLENBQUMsTUFBTSxDQUFDLENBQUM7QUFDdEIsQ0FBQztBQUVELFNBQVMsMEJBQTBCLENBQUMsUUFBa0I7SUFDcEQsTUFBTSxNQUFNLEdBQUcsUUFBUSxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsQ0FBQztJQUNwQyxNQUFNLE9BQU8sR0FBRyxRQUFRLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsQ0FBQztJQUU1QyxJQUFJLENBQUMsTUFBTSxFQUFFO1FBQ1gsT0FBTyxDQUFDLElBQUksQ0FBQyw0QkFBNEIsQ0FBQyxDQUFDO1FBQzNDLE9BQU87S0FDUjtJQUVELGFBQWEsQ0FBQyxNQUFNLEVBQUUsT0FBTyxDQUFDLENBQUM7QUFDakMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIENvbXBpbGVyT3B0aW9ucyxcbiAgZW5hYmxlUHJvZE1vZGUsXG4gIEluamVjdG9yLFxuICBOZ01vZHVsZVJlZixcbiAgTmdab25lLFxuICBQbGF0Zm9ybVJlZixcbiAgVHlwZSxcbiAgVmVyc2lvbixcbn0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBwbGF0Zm9ybUJyb3dzZXIgfSBmcm9tICdAYW5ndWxhci9wbGF0Zm9ybS1icm93c2VyJztcbmltcG9ydCB7IFZFUlNJT04gfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7XG4gIGdldEdsb2JhbFN0YXRlU2xpY2UsXG4gIHNldEdsb2JhbFN0YXRlU2xpY2UsXG59IGZyb20gJy4uL3V0aWxzL2dsb2JhbC1zdGF0ZSc7XG5pbXBvcnQgeyBSb3V0ZXIgfSBmcm9tICdAYW5ndWxhci9yb3V0ZXInO1xuaW1wb3J0IHsgY29ubmVjdFJvdXRlciB9IGZyb20gJy4vcm91dGVyLXV0aWxzJztcblxuZXhwb3J0IHR5cGUgQXBwVHlwZSA9ICdzaGVsbCcgfCAnbWljcm9mcm9udGVuZCc7XG5cbmV4cG9ydCB0eXBlIE9wdGlvbnMgPSB7XG4gIHByb2R1Y3Rpb246IGJvb2xlYW47XG4gIHBsYXRmb3JtRmFjdG9yeT86ICgpID0+IFBsYXRmb3JtUmVmO1xuICBjb21waWxlck9wdGlvbnM/OiBDb21waWxlck9wdGlvbnMgJiBCb290c3RyYXBPcHRpb25zO1xuICB2ZXJzaW9uPzogKCkgPT4gc3RyaW5nIHwgVmVyc2lvbjtcbiAgYXBwVHlwZT86IEFwcFR5cGU7XG4gIC8qKlxuICAgKiBPcHQtb3V0IG9mIG5nWm9uZSBzaGFyaW5nLlxuICAgKiBOb3QgcmVjb21tYW5kZWQuXG4gICAqIERlZmF1bHQgdmFsdWUgdHJ1ZS5cbiAgICovXG4gIG5nWm9uZVNoYXJpbmc/OiBib29sZWFuO1xuICAvKipcbiAgICogT3B0LW91dCBvZiBwbGF0Zm9ybVNoYXJpbmcgc2hhcmluZy5cbiAgICogUG9zc2libGUsIGlmIGRlcGVuZGVuY2llcyBhcmUgbm90IHNoYXJlZCBvciBlYWNoIGJvb3RzdHJhcHBlZFxuICAgKiByZW1vdGUgYXBwIHVzZXMgYSBkaWZmZXJlbnQgdmVyc2lvbi5cbiAgICogRGVmYXVsdCB2YWx1ZSB0cnVlLlxuICAgKi9cbiAgcGxhdGZvcm1TaGFyaW5nPzogYm9vbGVhbjtcbiAgLyoqXG4gICAqIERlYWN0aXZhdGUgc3VwcG9ydCBmb3IgbGVnYWN5IG1vZGUuXG4gICAqIE9ubHkgcmVjb21tYW5kZWQgaWYgYWxsIHVzZWQgaW1wbGVtZW50YXRpb25zIGRlcGVuZCBvblxuICAgKiBAYW5ndWxhci1hcmNoaXRlY3RzL21vZHVsZS1mZWRlcmF0aW9uLXRvb2xzID4gMTMuMC4xLlxuICAgKiBEZWZhdWx0IHZhbHVlIHRydWUuXG4gICAqL1xuICBhY3RpdmVMZWdhY3lNb2RlPzogYm9vbGVhbjtcbn07XG5cbmRlY2xhcmUgaW50ZXJmYWNlIEJvb3RzdHJhcE9wdGlvbnMge1xuICBuZ1pvbmU/OiBOZ1pvbmUgfCAnem9uZS5qcycgfCAnbm9vcCc7XG4gIG5nWm9uZUV2ZW50Q29hbGVzY2luZz86IGJvb2xlYW47XG4gIG5nWm9uZVJ1bkNvYWxlc2Npbmc/OiBib29sZWFuO1xufVxuXG5sZXQgbmdab25lU2hhcmluZyA9IHRydWU7XG5sZXQgcGxhdGZvcm1TaGFyaW5nID0gdHJ1ZTtcbmxldCBsZWdhY3lNb2RlID0gdHJ1ZTtcblxuZXhwb3J0IGZ1bmN0aW9uIGdldE1ham9yKHZlcnNpb246IHN0cmluZyk6IHN0cmluZyB7XG4gIGNvbnN0IHByZSA9IHZlcnNpb24ubWF0Y2goL1xcZCsvKVswXTtcbiAgY29uc3QgcG9zdCA9IHZlcnNpb24ubWF0Y2goLy0uKi8pO1xuXG4gIGlmICghcHJlKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKCdDb3VuZCBub3QgaWRlbnRpZnkgbWFqb3IgdmVyc2lvbjogJyArIHZlcnNpb24pO1xuICB9XG5cbiAgaWYgKHBvc3QpIHtcbiAgICByZXR1cm4gcHJlICsgcG9zdFswXTtcbiAgfVxuXG4gIHJldHVybiBwcmU7XG59XG5cbi8qKlxuICogTEVHQUNZIElNUExFTUVOVEFUSU9OUyBTVEFSVFxuICpcbiAqIENhbiBiZSBkZXByZWNhdGVkIGluIGxhdGVyIG1ham9yIHJlbGVhc2VzLlxuICpcbiAqIFRvIGluY3JlYXNlIGJhY2t3YXJkcyBjb21wYXRpYmlsaXR5IGxlZ2FjeSBhbmQgY3VycmVudCBuYW1lc3BhY2VzXG4gKiB3aXRoaW4gdGhlIHdpbmRvdyBvYmplY3QgYXJlIHVzZWQuXG4gKi9cblxuZXhwb3J0IHR5cGUgTGVnYWN5UGxhdGZvcm1DYWNoZSA9IHtcbiAgcGxhdGZvcm06IFJlY29yZDxzdHJpbmcsIFBsYXRmb3JtUmVmPjtcbn07XG5cbmZ1bmN0aW9uIGdldExlZ2FjeVBsYXRmb3JtQ2FjaGUoKTogTGVnYWN5UGxhdGZvcm1DYWNoZSB7XG4gIGNvbnN0IHBsYXRmb3JtQ2FjaGUgPSB3aW5kb3cgYXMgdW5rbm93biBhcyBMZWdhY3lQbGF0Zm9ybUNhY2hlO1xuICBwbGF0Zm9ybUNhY2hlLnBsYXRmb3JtID0gcGxhdGZvcm1DYWNoZS5wbGF0Zm9ybSB8fCB7fTtcbiAgcmV0dXJuIHBsYXRmb3JtQ2FjaGU7XG59XG5cbmZ1bmN0aW9uIGdldExlZ2FjeVBsYXRmb3JtKGtleTogc3RyaW5nKTogUGxhdGZvcm1SZWYge1xuICBjb25zdCBwbGF0Zm9ybSA9IGdldExlZ2FjeVBsYXRmb3JtQ2FjaGUoKS5wbGF0Zm9ybVtrZXldO1xuICAvKipcbiAgICogSWYgZGVwZW5kZW5jaWVzIGFyZSBub3Qgc2hhcmVkLCBwbGF0Zm9ybSB3aXRoIHNhbWUgdmVyc2lvbiBpcyBkaWZmZXJlbnRcbiAgICogYW5kIHNoYXJlZCBwbGF0Zm9ybSB3aWxsIG5vdCBiZSByZXR1cm5lZC5cbiAgICovXG4gIHJldHVybiBwbGF0Zm9ybSBpbnN0YW5jZW9mIFBsYXRmb3JtUmVmID8gcGxhdGZvcm0gOiBudWxsO1xufVxuXG5mdW5jdGlvbiBzZXRMZWdhY3lQbGF0Zm9ybShrZXk6IHN0cmluZywgcGxhdGZvcm06IFBsYXRmb3JtUmVmKTogdm9pZCB7XG4gIGdldExlZ2FjeVBsYXRmb3JtQ2FjaGUoKS5wbGF0Zm9ybVtrZXldID0gcGxhdGZvcm07XG59XG5cbmZ1bmN0aW9uIGdldExlZ2FjeU5nWm9uZSgpOiBOZ1pvbmUge1xuICByZXR1cm4gd2luZG93WyduZ1pvbmUnXTtcbn1cblxuZnVuY3Rpb24gc2V0TGVnYWN5Tmdab25lKHpvbmU6IE5nWm9uZSk6IHZvaWQge1xuICB3aW5kb3dbJ25nWm9uZSddID0gem9uZTtcbn1cblxuLyoqXG4gKiBMRUdBQ1kgSU1QTEVNRU5UQVRJT05TIEVORFxuICovXG5cbmZ1bmN0aW9uIGdldFBsYXRmb3JtQ2FjaGUoKTogTWFwPFZlcnNpb24sIFBsYXRmb3JtUmVmPiB7XG4gIHJldHVybiAoXG4gICAgZ2V0R2xvYmFsU3RhdGVTbGljZShcbiAgICAgIChzdGF0ZTogeyBwbGF0Zm9ybUNhY2hlOiBNYXA8VmVyc2lvbiwgUGxhdGZvcm1SZWY+IH0pID0+XG4gICAgICAgIHN0YXRlLnBsYXRmb3JtQ2FjaGVcbiAgICApIHx8XG4gICAgc2V0R2xvYmFsU3RhdGVTbGljZSh7XG4gICAgICBwbGF0Zm9ybUNhY2hlOiBuZXcgTWFwPFZlcnNpb24sIFBsYXRmb3JtUmVmPigpLFxuICAgIH0pLnBsYXRmb3JtQ2FjaGVcbiAgKTtcbn1cblxuZnVuY3Rpb24gc2V0UGxhdGZvcm0odmVyc2lvbjogVmVyc2lvbiwgcGxhdGZvcm06IFBsYXRmb3JtUmVmKTogdm9pZCB7XG4gIGlmIChwbGF0Zm9ybVNoYXJpbmcpIHtcbiAgICBsZWdhY3lNb2RlICYmIHNldExlZ2FjeVBsYXRmb3JtKHZlcnNpb24uZnVsbCwgcGxhdGZvcm0pO1xuICAgIGdldFBsYXRmb3JtQ2FjaGUoKS5zZXQodmVyc2lvbiwgcGxhdGZvcm0pO1xuICB9XG59XG5cbmZ1bmN0aW9uIGdldFBsYXRmb3JtKG9wdGlvbnM6IE9wdGlvbnMpOiBQbGF0Zm9ybVJlZiB7XG4gIGlmICghcGxhdGZvcm1TaGFyaW5nKSB7XG4gICAgcmV0dXJuIG9wdGlvbnMucGxhdGZvcm1GYWN0b3J5KCk7XG4gIH1cblxuICBjb25zdCB2ZXJzaW9uUmVzdWx0ID0gb3B0aW9ucy52ZXJzaW9uKCk7XG4gIGNvbnN0IHZlcnNpb24gPSB2ZXJzaW9uUmVzdWx0ID09PSBWRVJTSU9OLmZ1bGwgPyBWRVJTSU9OIDogdmVyc2lvblJlc3VsdDtcbiAgY29uc3QgdmVyc2lvbktleSA9IHR5cGVvZiB2ZXJzaW9uID09PSAnc3RyaW5nJyA/IHZlcnNpb24gOiB2ZXJzaW9uLmZ1bGw7XG5cbiAgbGV0IHBsYXRmb3JtID1cbiAgICBnZXRQbGF0Zm9ybUNhY2hlKCkuZ2V0KHZlcnNpb24gYXMgVmVyc2lvbikgfHxcbiAgICAobGVnYWN5TW9kZSAmJiBnZXRMZWdhY3lQbGF0Zm9ybSh2ZXJzaW9uS2V5KSk7XG5cbiAgaWYgKCFwbGF0Zm9ybSkge1xuICAgIHBsYXRmb3JtID0gb3B0aW9ucy5wbGF0Zm9ybUZhY3RvcnkoKTtcbiAgICBzZXRQbGF0Zm9ybShWRVJTSU9OLCBwbGF0Zm9ybSk7XG4gICAgb3B0aW9ucy5wcm9kdWN0aW9uICYmIGVuYWJsZVByb2RNb2RlKCk7XG4gIH1cblxuICByZXR1cm4gcGxhdGZvcm07XG59XG5cbmZ1bmN0aW9uIGdldE5nWm9uZSgpOiBOZ1pvbmUge1xuICByZXR1cm4gKFxuICAgIGdldEdsb2JhbFN0YXRlU2xpY2UoKHN0YXRlOiB7IG5nWm9uZTogTmdab25lIH0pID0+IHN0YXRlLm5nWm9uZSkgfHxcbiAgICBnZXRMZWdhY3lOZ1pvbmUoKVxuICApO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gc2hhcmVOZ1pvbmUoem9uZTogTmdab25lKTogdm9pZCB7XG4gIGlmIChuZ1pvbmVTaGFyaW5nKSB7XG4gICAgbGVnYWN5TW9kZSAmJiBzZXRMZWdhY3lOZ1pvbmUoem9uZSk7XG4gICAgc2V0R2xvYmFsU3RhdGVTbGljZSh7IG5nWm9uZTogem9uZSB9KTtcbiAgfVxufVxuXG5leHBvcnQgZnVuY3Rpb24gYm9vdHN0cmFwPE0+KFxuICBtb2R1bGU6IFR5cGU8TT4sXG4gIG9wdGlvbnM6IE9wdGlvbnNcbik6IFByb21pc2U8TmdNb2R1bGVSZWY8TT4+IHtcbiAgbmdab25lU2hhcmluZyA9IG9wdGlvbnMubmdab25lU2hhcmluZyAhPT0gZmFsc2U7XG4gIHBsYXRmb3JtU2hhcmluZyA9IG9wdGlvbnMucGxhdGZvcm1TaGFyaW5nICE9PSBmYWxzZTtcbiAgbGVnYWN5TW9kZSA9IG9wdGlvbnMuYWN0aXZlTGVnYWN5TW9kZSAhPT0gZmFsc2U7XG4gIG9wdGlvbnMucGxhdGZvcm1GYWN0b3J5ID1cbiAgICBvcHRpb25zLnBsYXRmb3JtRmFjdG9yeSB8fCAoKCkgPT4gcGxhdGZvcm1Ccm93c2VyKCkpO1xuICBvcHRpb25zLnZlcnNpb24gPSBvcHRpb25zLnZlcnNpb24gfHwgKCgpID0+IFZFUlNJT04pO1xuXG4gIGlmIChuZ1pvbmVTaGFyaW5nICYmICFvcHRpb25zLmNvbXBpbGVyT3B0aW9ucz8ubmdab25lKSB7XG4gICAgb3B0aW9ucy5jb21waWxlck9wdGlvbnMgPSBvcHRpb25zLmNvbXBpbGVyT3B0aW9ucyB8fCB7fTtcbiAgICBvcHRpb25zLmNvbXBpbGVyT3B0aW9ucy5uZ1pvbmUgPSBnZXROZ1pvbmUoKTtcbiAgfVxuXG4gIHJldHVybiBnZXRQbGF0Zm9ybShvcHRpb25zKVxuICAgIC5ib290c3RyYXBNb2R1bGUobW9kdWxlLCBvcHRpb25zLmNvbXBpbGVyT3B0aW9ucylcbiAgICAudGhlbigocmVmKSA9PiB7XG4gICAgICBpZiAob3B0aW9ucy5hcHBUeXBlID09PSAnc2hlbGwnKSB7XG4gICAgICAgIHNoYXJlU2hlbGxab25lKHJlZi5pbmplY3Rvcik7XG4gICAgICB9IGVsc2UgaWYgKG9wdGlvbnMuYXBwVHlwZSA9PT0gJ21pY3JvZnJvbnRlbmQnKSB7XG4gICAgICAgIGNvbm5lY3RNaWNyb0Zyb250ZW5kUm91dGVyKHJlZi5pbmplY3Rvcik7XG4gICAgICB9XG5cbiAgICAgIHJldHVybiByZWY7XG4gICAgfSk7XG59XG5cbmZ1bmN0aW9uIHNoYXJlU2hlbGxab25lKGluamVjdG9yOiBJbmplY3Rvcikge1xuICBjb25zdCBuZ1pvbmUgPSBpbmplY3Rvci5nZXQoTmdab25lLCBudWxsKTtcbiAgaWYgKCFuZ1pvbmUpIHtcbiAgICBjb25zb2xlLndhcm4oJ05vIE5nWm9uZSB0byBzaGFyZSBmb3VuZCcpO1xuICAgIHJldHVybjtcbiAgfVxuICBzaGFyZU5nWm9uZShuZ1pvbmUpO1xufVxuXG5mdW5jdGlvbiBjb25uZWN0TWljcm9Gcm9udGVuZFJvdXRlcihpbmplY3RvcjogSW5qZWN0b3IpIHtcbiAgY29uc3Qgcm91dGVyID0gaW5qZWN0b3IuZ2V0KFJvdXRlcik7XG4gIGNvbnN0IHVzZUhhc2ggPSBsb2NhdGlvbi5ocmVmLmluY2x1ZGVzKCcjJyk7XG5cbiAgaWYgKCFyb3V0ZXIpIHtcbiAgICBjb25zb2xlLndhcm4oJ05vIHJvdXRlciB0byBjb25uZWN0IGZvdW5kJyk7XG4gICAgcmV0dXJuO1xuICB9XG5cbiAgY29ubmVjdFJvdXRlcihyb3V0ZXIsIHVzZUhhc2gpO1xufVxuIl19