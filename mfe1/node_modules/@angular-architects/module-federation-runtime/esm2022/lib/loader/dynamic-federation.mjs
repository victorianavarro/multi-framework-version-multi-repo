let config = {};
const containerMap = {};
const remoteMap = {};
let isDefaultScopeInitialized = false;
async function lookupExposedModule(key, exposedModule) {
    const container = containerMap[key];
    const factory = await container.get(exposedModule);
    const Module = factory();
    return Module;
}
async function initRemote(container, key) {
    // const container = window[key] as Container;
    // Do we still need to initialize the remote?
    if (remoteMap[key]) {
        return container;
    }
    // Do we still need to initialize the share scope?
    if (!isDefaultScopeInitialized) {
        await __webpack_init_sharing__('default');
        isDefaultScopeInitialized = true;
    }
    await container.init(__webpack_share_scopes__.default);
    remoteMap[key] = true;
    return container;
}
export async function loadRemoteEntry(remoteEntryOrOptions, remoteName) {
    if (typeof remoteEntryOrOptions === 'string') {
        const remoteEntry = remoteEntryOrOptions;
        return await loadRemoteScriptEntry(remoteEntry, remoteName);
    }
    else if (remoteEntryOrOptions.type === 'script') {
        const options = remoteEntryOrOptions;
        return await loadRemoteScriptEntry(options.remoteEntry, options.remoteName);
    }
    else if (remoteEntryOrOptions.type === 'module') {
        const options = remoteEntryOrOptions;
        await loadRemoteModuleEntry(options.remoteEntry);
    }
}
async function loadRemoteModuleEntry(remoteEntry) {
    if (containerMap[remoteEntry]) {
        return Promise.resolve();
    }
    return await import(/* webpackIgnore:true */ remoteEntry).then((container) => {
        initRemote(container, remoteEntry);
        containerMap[remoteEntry] = container;
    });
}
async function loadRemoteScriptEntry(remoteEntry, remoteName) {
    return new Promise((resolve, reject) => {
        // Is remoteEntry already loaded?
        if (containerMap[remoteName]) {
            resolve();
            return;
        }
        const script = document.createElement('script');
        script.src = remoteEntry;
        script.onerror = reject;
        script.onload = () => {
            const container = window[remoteName];
            initRemote(container, remoteName);
            containerMap[remoteName] = container;
            resolve();
        };
        document.body.appendChild(script);
    });
}
export async function loadRemoteModule(optionsOrRemoteName, exposedModule) {
    let loadRemoteEntryOptions;
    let key;
    let remoteEntry;
    let options;
    if (typeof optionsOrRemoteName === 'string') {
        options = {
            type: 'manifest',
            remoteName: optionsOrRemoteName,
            exposedModule: exposedModule,
        };
    }
    else {
        options = optionsOrRemoteName;
    }
    // To support legacy API (< ng 13)
    if (!options.type) {
        const hasManifest = Object.keys(config).length > 0;
        options.type = hasManifest ? 'manifest' : 'script';
    }
    if (options.type === 'manifest') {
        const manifestEntry = config[options.remoteName];
        if (!manifestEntry) {
            throw new Error('Manifest does not contain ' + options.remoteName);
        }
        options = {
            type: manifestEntry.type,
            exposedModule: options.exposedModule,
            remoteEntry: manifestEntry.remoteEntry,
            remoteName: manifestEntry.type === 'script' ? options.remoteName : undefined,
        };
        remoteEntry = manifestEntry.remoteEntry;
    }
    else {
        remoteEntry = options.remoteEntry;
    }
    if (options.type === 'script') {
        loadRemoteEntryOptions = {
            type: 'script',
            remoteEntry: options.remoteEntry,
            remoteName: options.remoteName,
        };
        key = options.remoteName;
    }
    else if (options.type === 'module') {
        loadRemoteEntryOptions = {
            type: 'module',
            remoteEntry: options.remoteEntry,
        };
        key = options.remoteEntry;
    }
    if (remoteEntry) {
        await loadRemoteEntry(loadRemoteEntryOptions);
    }
    return await lookupExposedModule(key, options.exposedModule);
}
export async function setManifest(manifest, skipRemoteEntries = false) {
    config = parseConfig(manifest);
    if (!skipRemoteEntries) {
        await loadRemoteEntries();
    }
}
export function getManifest() {
    return config;
}
export async function initFederation(manifest, skipRemoteEntries = false) {
    if (typeof manifest === 'string') {
        return loadManifest(manifest, skipRemoteEntries);
    }
    else {
        return setManifest(manifest, skipRemoteEntries);
    }
}
export async function loadManifest(configFile, skipRemoteEntries = false) {
    const result = await fetch(configFile);
    if (!result.ok) {
        throw Error('could not load configFile: ' + configFile);
    }
    config = parseConfig(await result.json());
    if (!skipRemoteEntries) {
        await loadRemoteEntries();
    }
}
function parseConfig(config) {
    const result = {};
    for (const key in config) {
        const value = config[key];
        let entry;
        if (typeof value === 'string') {
            entry = {
                remoteEntry: value,
                type: 'module',
            };
        }
        else {
            entry = {
                ...value,
                type: value.type || 'module',
            };
        }
        result[key] = entry;
    }
    return result;
}
async function loadRemoteEntries() {
    const promises = [];
    for (const key in config) {
        const entry = config[key];
        if (entry.type === 'module') {
            promises.push(loadRemoteEntry({ type: 'module', remoteEntry: entry.remoteEntry }));
        }
        else {
            promises.push(loadRemoteEntry({
                type: 'script',
                remoteEntry: entry.remoteEntry,
                remoteName: key,
            }));
        }
    }
    await Promise.all(promises);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZHluYW1pYy1mZWRlcmF0aW9uLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vbGlicy9tZi1ydW50aW1lL3NyYy9saWIvbG9hZGVyL2R5bmFtaWMtZmVkZXJhdGlvbi50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFTQSxJQUFJLE1BQU0sR0FBYSxFQUFFLENBQUM7QUFxQjFCLE1BQU0sWUFBWSxHQUFpQixFQUFFLENBQUM7QUFDdEMsTUFBTSxTQUFTLEdBQUcsRUFBRSxDQUFDO0FBRXJCLElBQUkseUJBQXlCLEdBQUcsS0FBSyxDQUFDO0FBRXRDLEtBQUssVUFBVSxtQkFBbUIsQ0FDaEMsR0FBVyxFQUNYLGFBQXFCO0lBRXJCLE1BQU0sU0FBUyxHQUFHLFlBQVksQ0FBQyxHQUFHLENBQUMsQ0FBQztJQUNwQyxNQUFNLE9BQU8sR0FBRyxNQUFNLFNBQVMsQ0FBQyxHQUFHLENBQUMsYUFBYSxDQUFDLENBQUM7SUFDbkQsTUFBTSxNQUFNLEdBQUcsT0FBTyxFQUFFLENBQUM7SUFDekIsT0FBTyxNQUFXLENBQUM7QUFDckIsQ0FBQztBQUVELEtBQUssVUFBVSxVQUFVLENBQUMsU0FBb0IsRUFBRSxHQUFXO0lBQ3pELDhDQUE4QztJQUU5Qyw2Q0FBNkM7SUFDN0MsSUFBSSxTQUFTLENBQUMsR0FBRyxDQUFDLEVBQUU7UUFDbEIsT0FBTyxTQUFTLENBQUM7S0FDbEI7SUFFRCxrREFBa0Q7SUFDbEQsSUFBSSxDQUFDLHlCQUF5QixFQUFFO1FBQzlCLE1BQU0sd0JBQXdCLENBQUMsU0FBUyxDQUFDLENBQUM7UUFDMUMseUJBQXlCLEdBQUcsSUFBSSxDQUFDO0tBQ2xDO0lBRUQsTUFBTSxTQUFTLENBQUMsSUFBSSxDQUFDLHdCQUF3QixDQUFDLE9BQU8sQ0FBQyxDQUFDO0lBQ3ZELFNBQVMsQ0FBQyxHQUFHLENBQUMsR0FBRyxJQUFJLENBQUM7SUFDdEIsT0FBTyxTQUFTLENBQUM7QUFDbkIsQ0FBQztBQXdCRCxNQUFNLENB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O2FBQ2hCLENBQUMsQ0FDSCxDQUFDO1NBQ0g7S0FDRjtJQUVELE1BQU0sT0FBTyxDQUFDLEdBQUcsQ0FBQyxRQUFRLENBQUMsQ0FBQztBQUM5QixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsidHlwZSBTY29wZSA9IHVua25vd247XG4vLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQHR5cGVzY3JpcHQtZXNsaW50L25vLWV4cGxpY2l0LWFueVxudHlwZSBGYWN0b3J5ID0gKCkgPT4gYW55O1xuXG50eXBlIENvbnRhaW5lciA9IHtcbiAgaW5pdChzaGFyZVNjb3BlOiBTY29wZSk6IHZvaWQ7XG4gIGdldChtb2R1bGU6IHN0cmluZyk6IEZhY3Rvcnk7XG59O1xuXG5sZXQgY29uZmlnOiBNYW5pZmVzdCA9IHt9O1xuXG5leHBvcnQgdHlwZSBNYW5pZmVzdEZpbGU8VCBleHRlbmRzIFJlbW90ZUNvbmZpZyA9IFJlbW90ZUNvbmZpZz4gPSB7XG4gIFtrZXk6IHN0cmluZ106IHN0cmluZyB8IFQ7XG59O1xuXG5leHBvcnQgdHlwZSBNYW5pZmVzdDxUIGV4dGVuZHMgUmVtb3RlQ29uZmlnID0gUmVtb3RlQ29uZmlnPiA9IHtcbiAgW2tleTogc3RyaW5nXTogVDtcbn07XG5cbmV4cG9ydCB0eXBlIFJlbW90ZUNvbmZpZyA9IHtcbiAgdHlwZTogJ21vZHVsZScgfCAnc2NyaXB0JztcbiAgcmVtb3RlRW50cnk6IHN0cmluZztcbiAgW2tleTogc3RyaW5nXTogdW5rbm93bjtcbn07XG5cbmRlY2xhcmUgY29uc3QgX193ZWJwYWNrX2luaXRfc2hhcmluZ19fOiAoc2hhcmVTY29wZTogc3RyaW5nKSA9PiBQcm9taXNlPHZvaWQ+O1xuZGVjbGFyZSBjb25zdCBfX3dlYnBhY2tfc2hhcmVfc2NvcGVzX186IHsgZGVmYXVsdDogU2NvcGUgfTtcblxudHlwZSBDb250YWluZXJNYXAgPSB7IFtrZXk6IHN0cmluZ106IENvbnRhaW5lciB9O1xuXG5jb25zdCBjb250YWluZXJNYXA6IENvbnRhaW5lck1hcCA9IHt9O1xuY29uc3QgcmVtb3RlTWFwID0ge307XG5cbmxldCBpc0RlZmF1bHRTY29wZUluaXRpYWxpemVkID0gZmFsc2U7XG5cbmFzeW5jIGZ1bmN0aW9uIGxvb2t1cEV4cG9zZWRNb2R1bGU8VD4oXG4gIGtleTogc3RyaW5nLFxuICBleHBvc2VkTW9kdWxlOiBzdHJpbmdcbik6IFByb21pc2U8VD4ge1xuICBjb25zdCBjb250YWluZXIgPSBjb250YWluZXJNYXBba2V5XTtcbiAgY29uc3QgZmFjdG9yeSA9IGF3YWl0IGNvbnRhaW5lci5nZXQoZXhwb3NlZE1vZHVsZSk7XG4gIGNvbnN0IE1vZHVsZSA9IGZhY3RvcnkoKTtcbiAgcmV0dXJuIE1vZHVsZSBhcyBUO1xufVxuXG5hc3luYyBmdW5jdGlvbiBpbml0UmVtb3RlKGNvbnRhaW5lcjogQ29udGFpbmVyLCBrZXk6IHN0cmluZykge1xuICAvLyBjb25zdCBjb250YWluZXIgPSB3aW5kb3dba2V5XSBhcyBDb250YWluZXI7XG5cbiAgLy8gRG8gd2Ugc3RpbGwgbmVlZCB0byBpbml0aWFsaXplIHRoZSByZW1vdGU/XG4gIGlmIChyZW1vdGVNYXBba2V5XSkge1xuICAgIHJldHVybiBjb250YWluZXI7XG4gIH1cblxuICAvLyBEbyB3ZSBzdGlsbCBuZWVkIHRvIGluaXRpYWxpemUgdGhlIHNoYXJlIHNjb3BlP1xuICBpZiAoIWlzRGVmYXVsdFNjb3BlSW5pdGlhbGl6ZWQpIHtcbiAgICBhd2FpdCBfX3dlYnBhY2tfaW5pdF9zaGFyaW5nX18oJ2RlZmF1bHQnKTtcbiAgICBpc0RlZmF1bHRTY29wZUluaXRpYWxpemVkID0gdHJ1ZTtcbiAgfVxuXG4gIGF3YWl0IGNvbnRhaW5lci5pbml0KF9fd2VicGFja19zaGFyZV9zY29wZXNfXy5kZWZhdWx0KTtcbiAgcmVtb3RlTWFwW2tleV0gPSB0cnVlO1xuICByZXR1cm4gY29udGFpbmVyO1xufVxuXG5leHBvcnQgdHlwZSBMb2FkUmVtb3RlRW50cnlPcHRpb25zID1cbiAgfCBMb2FkUmVtb3RlRW50cnlTY3JpcHRPcHRpb25zXG4gIHwgTG9hZFJlbW90ZUVudHJ5RXNtT3B0aW9ucztcblxuZXhwb3J0IHR5cGUgTG9hZFJlbW90ZUVudHJ5U2NyaXB0T3B0aW9ucyA9IHtcbiAgdHlwZT86ICdzY3JpcHQnO1xuICByZW1vdGVFbnRyeTogc3RyaW5nO1xuICByZW1vdGVOYW1lOiBzdHJpbmc7XG59O1xuXG5leHBvcnQgdHlwZSBMb2FkUmVtb3RlRW50cnlFc21PcHRpb25zID0ge1xuICB0eXBlOiAnbW9kdWxlJztcbiAgcmVtb3RlRW50cnk6IHN0cmluZztcbn07XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBsb2FkUmVtb3RlRW50cnkoXG4gIHJlbW90ZUVudHJ5OiBzdHJpbmcsXG4gIHJlbW90ZU5hbWU6IHN0cmluZ1xuKTogUHJvbWlzZTx2b2lkPjtcbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBsb2FkUmVtb3RlRW50cnkoXG4gIG9wdGlvbnM6IExvYWRSZW1vdGVFbnRyeU9wdGlvbnNcbik6IFByb21pc2U8dm9pZD47XG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gbG9hZFJlbW90ZUVudHJ5KFxuICByZW1vdGVFbnRyeU9yT3B0aW9uczogc3RyaW5nIHwgTG9hZFJlbW90ZUVudHJ5T3B0aW9ucyxcbiAgcmVtb3RlTmFtZT86IHN0cmluZ1xuKTogUHJvbWlzZTx2b2lkPiB7XG4gIGlmICh0eXBlb2YgcmVtb3RlRW50cnlPck9wdGlvbnMgPT09ICdzdHJpbmcnKSB7XG4gICAgY29uc3QgcmVtb3RlRW50cnkgPSByZW1vdGVFbnRyeU9yT3B0aW9ucztcbiAgICByZXR1cm4gYXdhaXQgbG9hZFJlbW90ZVNjcmlwdEVudHJ5KHJlbW90ZUVudHJ5LCByZW1vdGVOYW1lKTtcbiAgfSBlbHNlIGlmIChyZW1vdGVFbnRyeU9yT3B0aW9ucy50eXBlID09PSAnc2NyaXB0Jykge1xuICAgIGNvbnN0IG9wdGlvbnMgPSByZW1vdGVFbnRyeU9yT3B0aW9ucztcbiAgICByZXR1cm4gYXdhaXQgbG9hZFJlbW90ZVNjcmlwdEVudHJ5KG9wdGlvbnMucmVtb3RlRW50cnksIG9wdGlvbnMucmVtb3RlTmFtZSk7XG4gIH0gZWxzZSBpZiAocmVtb3RlRW50cnlPck9wdGlvbnMudHlwZSA9PT0gJ21vZHVsZScpIHtcbiAgICBjb25zdCBvcHRpb25zID0gcmVtb3RlRW50cnlPck9wdGlvbnM7XG4gICAgYXdhaXQgbG9hZFJlbW90ZU1vZHVsZUVudHJ5KG9wdGlvbnMucmVtb3RlRW50cnkpO1xuICB9XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGxvYWRSZW1vdGVNb2R1bGVFbnRyeShyZW1vdGVFbnRyeTogc3RyaW5nKTogUHJvbWlzZTx2b2lkPiB7XG4gIGlmIChjb250YWluZXJNYXBbcmVtb3RlRW50cnldKSB7XG4gICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSgpO1xuICB9XG4gIHJldHVybiBhd2FpdCBpbXBvcnQoLyogd2VicGFja0lnbm9yZTp0cnVlICovIHJlbW90ZUVudHJ5KS50aGVuKFxuICAgIChjb250YWluZXIpID0+IHtcbiAgICAgIGluaXRSZW1vdGUoY29udGFpbmVyLCByZW1vdGVFbnRyeSk7XG4gICAgICBjb250YWluZXJNYXBbcmVtb3RlRW50cnldID0gY29udGFpbmVyO1xuICAgIH1cbiAgKTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gbG9hZFJlbW90ZVNjcmlwdEVudHJ5KFxuICByZW1vdGVFbnRyeTogc3RyaW5nLFxuICByZW1vdGVOYW1lOiBzdHJpbmdcbik6IFByb21pc2U8dm9pZD4ge1xuICByZXR1cm4gbmV3IFByb21pc2U8dm9pZD4oKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgIC8vIElzIHJlbW90ZUVudHJ5IGFscmVhZHkgbG9hZGVkP1xuICAgIGlmIChjb250YWluZXJNYXBbcmVtb3RlTmFtZV0pIHtcbiAgICAgIHJlc29sdmUoKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBjb25zdCBzY3JpcHQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdzY3JpcHQnKTtcbiAgICBzY3JpcHQuc3JjID0gcmVtb3RlRW50cnk7XG5cbiAgICBzY3JpcHQub25lcnJvciA9IHJlamVjdDtcblxuICAgIHNjcmlwdC5vbmxvYWQgPSAoKSA9PiB7XG4gICAgICBjb25zdCBjb250YWluZXIgPSB3aW5kb3dbcmVtb3RlTmFtZV0gYXMgQ29udGFpbmVyO1xuICAgICAgaW5pdFJlbW90ZShjb250YWluZXIsIHJlbW90ZU5hbWUpO1xuICAgICAgY29udGFpbmVyTWFwW3JlbW90ZU5hbWVdID0gY29udGFpbmVyO1xuICAgICAgcmVzb2x2ZSgpO1xuICAgIH07XG5cbiAgICBkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKHNjcmlwdCk7XG4gIH0pO1xufVxuXG5leHBvcnQgdHlwZSBMb2FkUmVtb3RlTW9kdWxlT3B0aW9ucyA9XG4gIHwgTG9hZFJlbW90ZU1vZHVsZVNjcmlwdE9wdGlvbnNcbiAgfCBMb2FkUmVtb3RlTW9kdWxlRXNtT3B0aW9uc1xuICB8IExvYWRSZW1vdGVNb2R1bGVNYW5pZmVzdE9wdGlvbnM7XG5cbmV4cG9ydCB0eXBlIExvYWRSZW1vdGVNb2R1bGVTY3JpcHRPcHRpb25zID0ge1xuICB0eXBlPzogJ3NjcmlwdCc7XG4gIHJlbW90ZUVudHJ5Pzogc3RyaW5nO1xuICByZW1vdGVOYW1lOiBzdHJpbmc7XG4gIGV4cG9zZWRNb2R1bGU6IHN0cmluZztcbn07XG5cbmV4cG9ydCB0eXBlIExvYWRSZW1vdGVNb2R1bGVFc21PcHRpb25zID0ge1xuICB0eXBlOiAnbW9kdWxlJztcbiAgcmVtb3RlRW50cnk6IHN0cmluZztcbiAgZXhwb3NlZE1vZHVsZTogc3RyaW5nO1xufTtcblxuZXhwb3J0IHR5cGUgTG9hZFJlbW90ZU1vZHVsZU1hbmlmZXN0T3B0aW9ucyA9IHtcbiAgdHlwZTogJ21hbmlmZXN0JztcbiAgcmVtb3RlTmFtZTogc3RyaW5nO1xuICBleHBvc2VkTW9kdWxlOiBzdHJpbmc7XG59O1xuXG4vLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQHR5cGVzY3JpcHQtZXNsaW50L25vLWV4cGxpY2l0LWFueVxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGxvYWRSZW1vdGVNb2R1bGU8VCA9IGFueT4oXG4gIHJlbW90ZU5hbWU6IHN0cmluZyxcbiAgZXhwb3NlZE1vZHVsZTogc3RyaW5nXG4pOiBQcm9taXNlPFQ+O1xuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGxvYWRSZW1vdGVNb2R1bGU8VCA9IGFueT4oXG4gIG9wdGlvbnM6IExvYWRSZW1vdGVNb2R1bGVPcHRpb25zXG4pOiBQcm9taXNlPFQ+O1xuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGxvYWRSZW1vdGVNb2R1bGU8VCA9IGFueT4oXG4gIG9wdGlvbnNPclJlbW90ZU5hbWU6IExvYWRSZW1vdGVNb2R1bGVPcHRpb25zIHwgc3RyaW5nLFxuICBleHBvc2VkTW9kdWxlPzogc3RyaW5nXG4pOiBQcm9taXNlPFQ+IHtcbiAgbGV0IGxvYWRSZW1vdGVFbnRyeU9wdGlvbnM6IExvYWRSZW1vdGVFbnRyeU9wdGlvbnM7XG4gIGxldCBrZXk6IHN0cmluZztcbiAgbGV0IHJlbW90ZUVudHJ5OiBzdHJpbmc7XG4gIGxldCBvcHRpb25zOiBMb2FkUmVtb3RlTW9kdWxlT3B0aW9ucztcblxuICBpZiAodHlwZW9mIG9wdGlvbnNPclJlbW90ZU5hbWUgPT09ICdzdHJpbmcnKSB7XG4gICAgb3B0aW9ucyA9IHtcbiAgICAgIHR5cGU6ICdtYW5pZmVzdCcsXG4gICAgICByZW1vdGVOYW1lOiBvcHRpb25zT3JSZW1vdGVOYW1lLFxuICAgICAgZXhwb3NlZE1vZHVsZTogZXhwb3NlZE1vZHVsZSxcbiAgICB9O1xuICB9IGVsc2Uge1xuICAgIG9wdGlvbnMgPSBvcHRpb25zT3JSZW1vdGVOYW1lO1xuICB9XG5cbiAgLy8gVG8gc3VwcG9ydCBsZWdhY3kgQVBJICg8IG5nIDEzKVxuICBpZiAoIW9wdGlvbnMudHlwZSkge1xuICAgIGNvbnN0IGhhc01hbmlmZXN0ID0gT2JqZWN0LmtleXMoY29uZmlnKS5sZW5ndGggPiAwO1xuICAgIG9wdGlvbnMudHlwZSA9IGhhc01hbmlmZXN0ID8gJ21hbmlmZXN0JyA6ICdzY3JpcHQnO1xuICB9XG5cbiAgaWYgKG9wdGlvbnMudHlwZSA9PT0gJ21hbmlmZXN0Jykge1xuICAgIGNvbnN0IG1hbmlmZXN0RW50cnkgPSBjb25maWdbb3B0aW9ucy5yZW1vdGVOYW1lXTtcbiAgICBpZiAoIW1hbmlmZXN0RW50cnkpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignTWFuaWZlc3QgZG9lcyBub3QgY29udGFpbiAnICsgb3B0aW9ucy5yZW1vdGVOYW1lKTtcbiAgICB9XG4gICAgb3B0aW9ucyA9IHtcbiAgICAgIHR5cGU6IG1hbmlmZXN0RW50cnkudHlwZSxcbiAgICAgIGV4cG9zZWRNb2R1bGU6IG9wdGlvbnMuZXhwb3NlZE1vZHVsZSxcbiAgICAgIHJlbW90ZUVudHJ5OiBtYW5pZmVzdEVudHJ5LnJlbW90ZUVudHJ5LFxuICAgICAgcmVtb3RlTmFtZTpcbiAgICAgICAgbWFuaWZlc3RFbnRyeS50eXBlID09PSAnc2NyaXB0JyA/IG9wdGlvbnMucmVtb3RlTmFtZSA6IHVuZGVmaW5lZCxcbiAgICB9O1xuICAgIHJlbW90ZUVudHJ5ID0gbWFuaWZlc3RFbnRyeS5yZW1vdGVFbnRyeTtcbiAgfSBlbHNlIHtcbiAgICByZW1vdGVFbnRyeSA9IG9wdGlvbnMucmVtb3RlRW50cnk7XG4gIH1cblxuICBpZiAob3B0aW9ucy50eXBlID09PSAnc2NyaXB0Jykge1xuICAgIGxvYWRSZW1vdGVFbnRyeU9wdGlvbnMgPSB7XG4gICAgICB0eXBlOiAnc2NyaXB0JyxcbiAgICAgIHJlbW90ZUVudHJ5OiBvcHRpb25zLnJlbW90ZUVudHJ5LFxuICAgICAgcmVtb3RlTmFtZTogb3B0aW9ucy5yZW1vdGVOYW1lLFxuICAgIH07XG4gICAga2V5ID0gb3B0aW9ucy5yZW1vdGVOYW1lO1xuICB9IGVsc2UgaWYgKG9wdGlvbnMudHlwZSA9PT0gJ21vZHVsZScpIHtcbiAgICBsb2FkUmVtb3RlRW50cnlPcHRpb25zID0ge1xuICAgICAgdHlwZTogJ21vZHVsZScsXG4gICAgICByZW1vdGVFbnRyeTogb3B0aW9ucy5yZW1vdGVFbnRyeSxcbiAgICB9O1xuICAgIGtleSA9IG9wdGlvbnMucmVtb3RlRW50cnk7XG4gIH1cblxuICBpZiAocmVtb3RlRW50cnkpIHtcbiAgICBhd2FpdCBsb2FkUmVtb3RlRW50cnkobG9hZFJlbW90ZUVudHJ5T3B0aW9ucyk7XG4gIH1cblxuICByZXR1cm4gYXdhaXQgbG9va3VwRXhwb3NlZE1vZHVsZTxUPihrZXksIG9wdGlvbnMuZXhwb3NlZE1vZHVsZSk7XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBzZXRNYW5pZmVzdChcbiAgbWFuaWZlc3Q6IE1hbmlmZXN0RmlsZSxcbiAgc2tpcFJlbW90ZUVudHJpZXMgPSBmYWxzZVxuKSB7XG4gIGNvbmZpZyA9IHBhcnNlQ29uZmlnKG1hbmlmZXN0KTtcblxuICBpZiAoIXNraXBSZW1vdGVFbnRyaWVzKSB7XG4gICAgYXdhaXQgbG9hZFJlbW90ZUVudHJpZXMoKTtcbiAgfVxufVxuXG5leHBvcnQgZnVuY3Rpb24gZ2V0TWFuaWZlc3Q8VCBleHRlbmRzIE1hbmlmZXN0PigpOiBUIHtcbiAgcmV0dXJuIGNvbmZpZyBhcyBUO1xufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gaW5pdEZlZGVyYXRpb24oXG4gIG1hbmlmZXN0OiBzdHJpbmcgfCBNYW5pZmVzdEZpbGUsXG4gIHNraXBSZW1vdGVFbnRyaWVzID0gZmFsc2Vcbik6IFByb21pc2U8dm9pZD4ge1xuICBpZiAodHlwZW9mIG1hbmlmZXN0ID09PSAnc3RyaW5nJykge1xuICAgIHJldHVybiBsb2FkTWFuaWZlc3QobWFuaWZlc3QsIHNraXBSZW1vdGVFbnRyaWVzKTtcbiAgfSBlbHNlIHtcbiAgICByZXR1cm4gc2V0TWFuaWZlc3QobWFuaWZlc3QsIHNraXBSZW1vdGVFbnRyaWVzKTtcbiAgfVxufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gbG9hZE1hbmlmZXN0KFxuICBjb25maWdGaWxlOiBzdHJpbmcsXG4gIHNraXBSZW1vdGVFbnRyaWVzID0gZmFsc2Vcbik6IFByb21pc2U8dm9pZD4ge1xuICBjb25zdCByZXN1bHQgPSBhd2FpdCBmZXRjaChjb25maWdGaWxlKTtcblxuICBpZiAoIXJlc3VsdC5vaykge1xuICAgIHRocm93IEVycm9yKCdjb3VsZCBub3QgbG9hZCBjb25maWdGaWxlOiAnICsgY29uZmlnRmlsZSk7XG4gIH1cblxuICBjb25maWcgPSBwYXJzZUNvbmZpZyhhd2FpdCByZXN1bHQuanNvbigpKTtcblxuICBpZiAoIXNraXBSZW1vdGVFbnRyaWVzKSB7XG4gICAgYXdhaXQgbG9hZFJlbW90ZUVudHJpZXMoKTtcbiAgfVxufVxuXG5mdW5jdGlvbiBwYXJzZUNvbmZpZyhjb25maWc6IE1hbmlmZXN0RmlsZSk6IE1hbmlmZXN0IHtcbiAgY29uc3QgcmVzdWx0OiBNYW5pZmVzdCA9IHt9O1xuICBmb3IgKGNvbnN0IGtleSBpbiBjb25maWcpIHtcbiAgICBjb25zdCB2YWx1ZSA9IGNvbmZpZ1trZXldO1xuXG4gICAgbGV0IGVudHJ5OiBSZW1vdGVDb25maWc7XG4gICAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gJ3N0cmluZycpIHtcbiAgICAgIGVudHJ5ID0ge1xuICAgICAgICByZW1vdGVFbnRyeTogdmFsdWUsXG4gICAgICAgIHR5cGU6ICdtb2R1bGUnLFxuICAgICAgfTtcbiAgICB9IGVsc2Uge1xuICAgICAgZW50cnkgPSB7XG4gICAgICAgIC4uLnZhbHVlLFxuICAgICAgICB0eXBlOiB2YWx1ZS50eXBlIHx8ICdtb2R1bGUnLFxuICAgICAgfTtcbiAgICB9XG5cbiAgICByZXN1bHRba2V5XSA9IGVudHJ5O1xuICB9XG4gIHJldHVybiByZXN1bHQ7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGxvYWRSZW1vdGVFbnRyaWVzKCkge1xuICBjb25zdCBwcm9taXNlczogUHJvbWlzZTx2b2lkPltdID0gW107XG5cbiAgZm9yIChjb25zdCBrZXkgaW4gY29uZmlnKSB7XG4gICAgY29uc3QgZW50cnkgPSBjb25maWdba2V5XTtcblxuICAgIGlmIChlbnRyeS50eXBlID09PSAnbW9kdWxlJykge1xuICAgICAgcHJvbWlzZXMucHVzaChcbiAgICAgICAgbG9hZFJlbW90ZUVudHJ5KHsgdHlwZTogJ21vZHVsZScsIHJlbW90ZUVudHJ5OiBlbnRyeS5yZW1vdGVFbnRyeSB9KVxuICAgICAgKTtcbiAgICB9IGVsc2Uge1xuICAgICAgcHJvbWlzZXMucHVzaChcbiAgICAgICAgbG9hZFJlbW90ZUVudHJ5KHtcbiAgICAgICAgICB0eXBlOiAnc2NyaXB0JyxcbiAgICAgICAgICByZW1vdGVFbnRyeTogZW50cnkucmVtb3RlRW50cnksXG4gICAgICAgICAgcmVtb3RlTmFtZToga2V5LFxuICAgICAgICB9KVxuICAgICAgKTtcbiAgICB9XG4gIH1cblxuICBhd2FpdCBQcm9taXNlLmFsbChwcm9taXNlcyk7XG59XG4iXX0=